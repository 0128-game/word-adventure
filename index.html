<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>文字アドベンチャー JS版</title>
    <style>
        body { background: #111; color: #eee; font-family: monospace; display: flex; flex-direction: column; align-items: center; }
        #status { font-size: 1.2rem; background: #222; padding: 10px; width: 100%; text-align: center; border-bottom: 2px solid #444; }
        #game-container { display: flex; gap: 20px; margin-top: 20px; }
        #screen { background: black; border: 2px solid #555; padding: 10px; font-size: 24px; line-height: 1.2; white-space: pre; }
        #log { width: 400px; height: 120px; background: #050505; border: 1px solid #333; padding: 10px; overflow-y: auto; color: #aaa; font-size: 14px; margin-top: 10px; }
        #ui-panel { background: #222; padding: 15px; border-radius: 8px; min-width: 180px; }
        .legend-item { margin-bottom: 5px; }
        .key-info { color: #888; font-size: 12px; margin-top: 15px; }
    </style>
</head>
<body>

<div id="status">読み込み中...</div>

<div id="game-container">
    <div>
        <div id="screen"></div>
        <div id="log"></div>
    </div>
    <div id="ui-panel">
        <strong>【凡例】</strong><br><br>
        <div id="legend"></div>
        <div class="key-info">
            [矢印キー]: 移動<br>
            [S]: セーブ(呪文出力)<br>
            [L]: ロード(呪文入力)
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        chars: { "@": "white", "#": "#444", "K": "yellow", "D": "orange", "S": "#aaf", "H": "#5f5", "C": "gold", "E": "red", "W": "magenta", "G": "cyan", ".": "#222" },
        names: { "@": "YOU", "#": "壁", "K": "鍵", "D": "扉", "S": "剣", "H": "薬", "C": "金", "E": "敵", "W": "穴", "G": "出口" }
    };

    let state = {
        hp: 10, maxHp: 10, atk: 1, coins: 0,
        inv: { K: 0, S: 0, H: 0 },
        w: 10, h: 5, px: 1, py: 1,
        map: []
    };

    function init() {
        state.map = Array.from({ length: state.h }, () => Array(state.w).fill("."));
        renderLegend();
        update();
        window.addEventListener("keydown", handleKey);
    }

    function renderLegend() {
        const container = document.getElementById("legend");
        for (let c in CONFIG.names) {
            container.innerHTML += `<div class="legend-item"><span style="color:${CONFIG.chars[c]}">${c}</span>: ${CONFIG.names[c]}</div>`;
        }
    }

    function update() {
        // ステータス更新
        document.getElementById("status").innerText = 
            `HP: ${state.hp}/${state.maxHp} | ATK: ${state.atk} | 金: ${state.coins} | 鍵: ${state.inv.K} | 剣: ${state.inv.S} | 薬: ${state.inv.H}`;
        
        // マップ描画
        let html = "";
        for (let y = 0; y < state.h; y++) {
            for (let x = 0; x < state.w; x++) {
                const char = (x === state.px && y === state.py) ? "@" : state.map[y][x];
                html += `<span style="color:${CONFIG.chars[char]}">${char}</span>`;
            }
            html += "\n";
        }
        document.getElementById("screen").innerHTML = html;
    }

    function log(msg) {
        const div = document.getElementById("log");
        div.innerHTML = `> ${msg}<br>` + div.innerHTML;
    }

    function handleKey(e) {
        const k = e.key.toLowerCase();
        if (k === "arrowup") move(0, -1);
        else if (k === "arrowdown") move(0, 1);
        else if (k === "arrowleft") move(-1, 0);
        else if (k === "arrowright") move(1, 0);
        else if (k === "s") save();
        else if (k === "l") load();
    }

    function move(dx, dy) {
        const nx = state.px + dx, ny = state.py + dy;
        if (ny < 0 || ny >= state.h || nx < 0 || nx >= state.w) return;
        const tile = state.map[ny][nx];
        if (tile === "#") return;

        if (tile === "E") {
            if (state.atk >= 2) { log("敵を撃破！"); state.map[ny][nx] = "."; }
            else { 
                state.hp -= 3; log("痛恨のダメージ！ HP-3");
                if (state.hp <= 0) { alert("死亡しました"); location.reload(); return; }
                update(); return;
            }
        }

        if (state.inv.hasOwnProperty(tile)) {
            state.inv[tile]++;
            if (tile === "S") state.atk++;
            if (tile === "H") { state.inv.H--; state.hp = Math.min(state.maxHp, state.hp + 5); }
            state.map[ny][nx] = ".";
            log(`${CONFIG.names[tile]}を入手！`);
        } else if (tile === "C") {
            state.coins += 10; state.map[ny][nx] = "."; log("金貨を獲得！");
        } else if (tile === "D") {
            if (state.inv.K > 0) { state.inv.K--; state.map[ny][nx] = "."; log("扉を開けた。"); }
            else { log("鍵が足りない！"); return; }
        } else if (tile === "G") { alert("脱出成功！"); location.reload(); return; }

        state.px = nx; state.py = ny;

        if (tile === "W") {
            const warps = [];
            for(let y=0; y<state.h; y++) for(let x=0; x<state.w; x++) if(state.map[y][x]==="W") warps.push({x,y});
            if (warps.length > 1) {
                const other = warps.find(v => v.x !== nx || v.y !== ny);
                state.px = other.x; state.py = other.y;
            }
        }
        update();
    }

    function save() {
        const mStr = state.map.map(r => r.join("")).join("");
        const raw = `${state.w}_${state.h}_${state.px}_${state.py}_${state.hp}_${state.maxHp}_${state.atk}_${state.coins}_${state.inv.K}_${state.inv.S}_${state.inv.H}_${mStr}`;
        const code = btoa(unescape(encodeURIComponent(raw)));
        window.prompt("呪文をコピーしてください:", code);
    }

    function load() {
        const code = window.prompt("呪文を入力してください:");
        if (!code) return;
        try {
            const p = decodeURIComponent(escape(atob(code))).split("_");
            state.w = parseInt(p[0]); state.h = parseInt(p[1]);
            state.px = parseInt(p[2]); state.py = parseInt(p[3]);
            state.hp = parseInt(p[4]); state.maxHp = parseInt(p[5]);
            state.atk = parseInt(p[6]); state.coins = parseInt(p[7]);
            state.inv.K = parseInt(p[8]); state.inv.S = parseInt(p[9]); state.inv.H = parseInt(p[10]);
            const mData = p[11];
            state.map = [];
            for (let i = 0; i < state.h; i++) state.map.push(mData.slice(i * state.w, (i + 1) * state.w).split(""));
            update();
            log("世界を復元しました。");
        } catch (e) { log("呪文が間違っています。"); }
    }

    init();
</script>
</body>
</html>
